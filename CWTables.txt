drop schema TicketSystem cascade;
create schema TicketSystem;
set search_path to TicketSystem;

CREATE TABLE Staff
(
	StaffID		INTEGER PRIMARY KEY,
	Name			VARCHAR(40) NOT NULL
		check (Name <> '')
);

CREATE TABLE Product
(
	ProductID		INTEGER PRIMARY KEY,
	Name			VARCHAR(40) NOT NULL
		check (Name <> '')
);

CREATE TABLE Customer
(
	CustomerID		INTEGER PRIMARY KEY,
	Name			VARCHAR(40) NOT NULL
		check (Name <> ''),
	Email			VARCHAR(40) NOT NULL UNIQUE
		check (Email <> '')
);

CREATE TABLE Ticket
(
	TicketID		INTEGER PRIMARY KEY,
	Problem		VARCHAR(1000) NOT NULL
		check (Problem <> ''),
	Status		VARCHAR(20) NOT NULL,
	Priority		INTEGER NOT NULL
		CHECK (Priority >= 1 and Priority <= 3),
	LoggedTime		TIMESTAMP NOT NULL,
	CustomerID		INTEGER NOT NULL,
	FOREIGN KEY (CustomerID) REFERENCES Customer
			ON DELETE RESTRICT
			ON UPDATE CASCADE,
	ProductID		INTEGER NOT NULL,
	FOREIGN KEY (ProductID) REFERENCES Product
			ON DELETE CASCADE
			ON UPDATE CASCADE
);

CREATE TABLE TicketUpdate
(
	TicketUpdateID	INTEGER PRIMARY KEY,
	Message		VARCHAR(1000) NOT NULL
		check (Message <> ''),
	UpdateTime		TIMESTAMP NOT NULL,
	TicketID		INTEGER NOT NULL,
	FOREIGN KEY (TicketID) REFERENCES Ticket
			ON DELETE CASCADE
			ON UPDATE CASCADE,
	StaffID		INTEGER,
	FOREIGN KEY (StaffID) REFERENCES Staff
			ON DELETE RESTRICT
			ON UPDATE CASCADE
);

create or replace function ticketHasUpdate (integer) returns bool as'	
	SELECT EXISTS(select TicketID from TicketUpdate where TicketID = $1);
'
	language sql;
	
Alter table Ticket
	add constraint status_check check ((Status = 'open') or (Status = 'closed' and ticketHasUpdate(TicketID) = true));

create or replace function StatusDomainIntegrityCorrection() returns trigger as $$
begin
update ticket set status = 'open' where (tickethasupdate(ticketID) = false);
end
$$ language plpgsql;

create trigger StatusDomainIntegrityTrigger
after delete on ticketupdate
execute procedure StatusDomainIntegrityCorrection();	

--EXPECT INDEX INSTRUCTIONS HERE